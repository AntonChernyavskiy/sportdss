<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Sport System</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Exo+2:300,400,700|Maven+Pro:400,700|Montserrat:300,400,700|Titillium+Web:300,400,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=430px" />
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="stylesheet" href="../css/index.css">
    <meta charset="utf-8">
    <style>
        .table-column-participant {
            width: 50% !important;
        }

        .table-column-birthyear {
            width: 25% !important;
        }

        .table-column-boatclass {
            width: 25% !important;
        }
		
		@media print {
            .club-table-container {
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <div class="navbar-brand" href="/">
                <span>
                    Digital Sport System
                </span>
            </div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav" style="padding-right: 10px; margin-right: 10px;">
                    <li class="nav-item hvr-underline-from-left">
                        <a class="nav-link" href="https://sportdss.eu/results">Rezultāti</a>
                    </li>
                    <li class="nav-item hvr-underline-from-left active">
                        <a class="nav-link" href="https://sportdss.eu">Pieteikšanas</a>
                    </li>
                    <li class="nav-item hvr-underline-from-left">
                        <a class="nav-link" href="https://sportdss.eu/results">Dzīvie rezultāti</a>
                    </li>
                </ul>
                <ul class="navbar-nav mr-auto">
                </ul>
                <ul class="navbar-nav justify-content-end">
                    <li class="nav-item hvr-underline-from-left">
                        <a class="nav-link" href="https://sportdss.eu/projekts">Projekta darbs</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container main-content">
        <div class="row mb-4 d-print-none">
            <div class="col">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title" id="event-title">Event Title</h5>
                        <h6 class="card-subtitle mb-2 text-muted" style="font-size: small;" id="event-date">Event Date</h6>
                        <div class="row d-print-none">
                            <div class="col">
                                <h6 style="margin-top: 5px; margin-bottom: 7px; float: left; margin-right: 20px;">
                                    <i style="margin: 0px 10px;" class="far fa-window-restore"></i>
                                    Skatīšanas režīms:
                                </h6>
                                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                                    <a id="sort-by-boat-class" class="btn btn-primary">pēc kategorijām</a>
                                    <a id="sort-by-club" class="btn btn-secondary">pēc sportistiem</a>
                                    <a id="show-stats" class="btn btn-secondary">statistika</a>
                                </div>
                            </div>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
        <div id="entry-list-container"></div>
    </div>
    <footer style="text-align: center;" class="d-print-none">
        <br>
        <hr>
        2024 © Digital Sport System. All rights reserved.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
			const urlParams = new URLSearchParams(window.location.search);
			const eventName = urlParams.get('event');
			const eventDate = urlParams.get('date');
			const eventId = urlParams.get('id');

			const eventTitleElement = document.getElementById('event-title');
			const eventDateElement = document.getElementById('event-date');

			if (eventTitleElement) {
				eventTitleElement.textContent = eventName ? decodeURIComponent(eventName) : 'Event Title';
			}

			if (eventDateElement) {
				eventDateElement.textContent = eventDate ? decodeURIComponent(eventDate) : 'Event Date';
			}

			const entryListContainer = document.getElementById('entry-list-container');
			const csvFilePath = `../entrySys/${encodeURIComponent(eventId)}___${encodeURIComponent(eventDate)}___${encodeURIComponent(eventName)}/entries.csv`;

			let boatClassTables = {};

			function renderTable(boatClassTables) {
				entryListContainer.innerHTML = '';

				Object.keys(boatClassTables).forEach((boatClass, tableIndex) => {
					const containerDiv = document.createElement('div');
					containerDiv.classList.add('row');
					containerDiv.id = boatClass;
					containerDiv.style.pageBreakAfter = 'always';

					const colDiv = document.createElement('div');
					colDiv.classList.add('col');

					const table = document.createElement('table');
					table.classList.add('table', 'table-hover', 'table-bordered');

					const categoryHeaderRow = document.createElement('tr');
					const categoryHeaderCell = document.createElement('th');
					categoryHeaderCell.classList.add('club-header');
					categoryHeaderCell.style.borderTop = '2px solid #aaa';
					categoryHeaderCell.colSpan = '5';
					categoryHeaderCell.innerHTML = `
						<span class="competition-number">${tableIndex + 1}</span>
						<span class="competition-symbol">${boatClass}</span>
					`;
					categoryHeaderRow.appendChild(categoryHeaderCell);
					table.appendChild(categoryHeaderRow);

					const headerRow = document.createElement('tr');
					['#', 'Organizācija', 'Dalībnieki', 'Treneri', 'Pieteikšanas laiks'].forEach((header) => {
						const th = document.createElement('th');
						th.textContent = header;
						th.classList.add(`table-header-${header.toLowerCase().replace('ā', 'a').replace(/\s+/g, '-')}`);
						headerRow.appendChild(th);
					});
					table.appendChild(headerRow);

					boatClassTables[boatClass].forEach((row, rowIndex) => {
						const tr = document.createElement('tr');
						const participantCells = row[2].split('<br>').map(participant => participant.trim());
						const currentYear = new Date().getFullYear();
						const organizations = new Set();

						const participantNames = participantCells.map(participant => {
							const [_, name] = participant.split(' | ');
							return name ? name.trim() : participant;
						});

						participantCells.forEach(participant => {
							const orgMatch = participant.match(/^[^\|]+\|/);
							if (orgMatch) {
								const organization = orgMatch[0].replace('|', '').trim();
								organizations.add(organization);
							}
						});

						const organizationsText = Array.from(organizations).join(', ');

						const ages = participantNames.map(cell => {
							const match = cell.match(/(\d{2})$/);
							if (match) {
								const birthYear = parseInt(match[1], 10);
								const fullYear = (birthYear >= currentYear % 100) ? 1900 + birthYear : 2000 + birthYear;
								return currentYear - fullYear;
							}
							return null;
						}).filter(age => age !== null);

						const averageAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b) / ages.length) : 'N/A';
						const coachText = row[4] ? `${row[4]}<br><b>vid. vecums: ${averageAge}</b>` : `<br><b>vid. vecums: ${averageAge}</b>`;

						const localTime = new Date(row[5] + ' UTC').toLocaleString();

						const cells = [
							(rowIndex + 1).toString(),
							organizationsText || row[1],
							participantNames.map(name => `<span>${name}</span><br>`).join(''),
							coachText,
							localTime
						];

						cells.forEach((cell, cellIndex) => {
							const td = document.createElement('td');
							td.innerHTML = cell;
							if (cellIndex === cells.length - 1) {
								td.classList.add('table-header-time');
							}
							tr.appendChild(td);
						});

						table.appendChild(tr);
					});

					colDiv.appendChild(table);
					containerDiv.appendChild(colDiv);
					entryListContainer.appendChild(containerDiv);
				});
			}

			function fetchData() {
				fetch(csvFilePath)
					.then(response => {
						if (!response.ok) {
							throw new Error('Failed to fetch entries');
						}
						return response.text();
					})
					.then(data => {
						const lines = data.split('\n').map(line => line.split(',').map(cell => cell.trim()));
						const headers = lines[0];

						const boatClassIndex = headers.indexOf('Event Abbrev');
						const participantIndex = headers.indexOf('Stroke');
						const coachIndex = headers.indexOf('Coach');
						const timeIndex = headers.indexOf('Time');
						const contactInfoIndex = headers.indexOf('Contact Information');

						if (boatClassIndex === -1 || participantIndex === -1 || coachIndex === -1 || timeIndex === -1 || contactInfoIndex === -1) {
							console.error('Required columns are missing in the CSV file');
							throw new Error('Required columns are missing in the CSV file');
						}

						boatClassTables = {};
						lines.slice(1).forEach(line => {
							const boatClass = line[boatClassIndex];
							if (!boatClassTables[boatClass]) {
								boatClassTables[boatClass] = [];
							}
							const modifiedLine = line.filter((_, index) => index !== boatClassIndex);

							if (modifiedLine[participantIndex]) {
								modifiedLine[participantIndex] = modifiedLine[participantIndex]
									.replace(/"/g, '')
									.replace(/\s*\/\s*/g, '<br>');
							}

							boatClassTables[boatClass].push([line[0], ...modifiedLine]);
						});

						renderTable(boatClassTables);
					})
					.catch(error => {
						console.error('Error fetching entries:', error);
						entryListContainer.textContent = 'No data to show';
					});
			}

			fetchData();

			function sortByBoatClass() {
				renderTable(boatClassTables);
			}
			
			function checkImageExists(url) {
				return new Promise((resolve) => {
					const img = new Image();
					img.onload = () => resolve(true);
					img.onerror = () => resolve(false);
					img.src = url;
				});
			}

            async function sortByClub() {
				const clubTables = {};

				try {
					const formattedEventDate = eventDate.replace(/-/g, '-'); // Replace dashes with underscores
					const filePath = `../entrySys/${eventId}___${formattedEventDate}___${encodeURIComponent(eventName)}/participants.csv`;

					const response = await fetch(filePath);

					if (!response.ok) {
						throw new Error(`Failed to fetch participants.csv: ${response.status} ${response.statusText}`);
					}
					const csvText = await response.text();

					const lines = csvText.split('\n').map(line => line.split(',').map(cell => cell.trim()));
					const headers = lines[0];

					const boatClassIndex = headers.indexOf('Event Abbrev');
					const organizationIndex = headers.indexOf('Crew');
					const participantsIndex = headers.indexOf('Stroke');

					if (boatClassIndex === -1 || organizationIndex === -1 || participantsIndex === -1) {
						console.error('Required columns are missing in participants.csv');
						return;
					}

					lines.slice(1).forEach(row => {
						const boatClass = row[boatClassIndex] || 'Unknown';
						let organization = row[organizationIndex] || 'Unknown';
						let participants = row[participantsIndex] || '';

						if (participants.includes(' | ')) {
							const parts = participants.split(' | ');
							organization = parts[0] || organization;
							participants = parts[1] || '';
						}

						if (!clubTables[organization]) {
							clubTables[organization] = [];
						}

						const participantList = participants.split('<br>').map(participant => participant.trim());
						participantList.forEach(participant => {
							const match = participant.match(/(\d{2})$/);
							if (match) {
								const year = parseInt(match[1], 10);
								const currentYear = new Date().getFullYear();
								const fullYear = (year >= currentYear % 100) ? 1900 + year : 2000 + year;
								const name = participant.replace(/\d{2}$/, '').trim();

								clubTables[organization].push({
									name,
									year: fullYear,
									boatClass: boatClass
								});
							}
						});
					});

					const uniqueClubTables = {};
					Object.keys(clubTables).forEach(club => {
						const entries = clubTables[club];
						const uniqueEntries = {};

						entries.forEach(entry => {
							if (!uniqueEntries[entry.name]) {
								uniqueEntries[entry.name] = [];
							}
							uniqueEntries[entry.name].push(entry.boatClass);
						});

						uniqueClubTables[club] = Object.keys(uniqueEntries).map(name => ({
							name,
							year: entries.find(entry => entry.name === name).year,
							boatClasses: uniqueEntries[name].join('<br>')
						}));
					});

					Object.keys(uniqueClubTables).forEach(club => {
						uniqueClubTables[club].sort((a, b) => {
							const nameComparison = a.name.localeCompare(b.name);
							if (nameComparison !== 0) return nameComparison;
							return a.boatClasses.localeCompare(b.boatClasses);
						});
					});

					const sortedClubs = Object.keys(uniqueClubTables).sort((a, b) => a.localeCompare(b));

					entryListContainer.innerHTML = '';

					sortedClubs.forEach((club, clubIndex) => {
						const containerDiv = document.createElement('div');
						containerDiv.classList.add('row');
						containerDiv.id = `club-${clubIndex}`;
						containerDiv.style.pageBreakAfter = 'always';

						const colDiv = document.createElement('div');
						colDiv.classList.add('col');

						const table = document.createElement('table');
						table.classList.add('table', 'table-hover', 'table-bordered');

						const clubHeaderRow = document.createElement('tr');
						const clubHeaderCell = document.createElement('th');
						clubHeaderCell.classList.add('club-header');
						clubHeaderCell.style.borderTop = '2px solid #aaa';
						clubHeaderCell.colSpan = '3';

						const flagPath = `entrySys/${eventId}___${formattedEventDate}___${encodeURIComponent(eventName)}/flags/${club}.svg`;
						const flagImg = new Image();
						flagImg.src = flagPath;
						flagImg.alt = `${club} Flag`;
						flagImg.style.width = '30px';
						flagImg.style.height = 'auto';
						flagImg.style.verticalAlign = 'middle';
						flagImg.style.marginRight = '10px';
						flagImg.style.display = 'inline-block';

						flagImg.onload = () => {
							clubHeaderCell.innerHTML = `
								<span style="display: flex; align-items: center;">
									<span class="competition-number">${clubIndex + 1}</span>
									<img src="${flagImg.src}" alt="${flagImg.alt}" style="${flagImg.style.cssText}" />
									<span class="competition-symbol">${club}</span>
								</span>
							`;
							clubHeaderRow.appendChild(clubHeaderCell);
							table.appendChild(clubHeaderRow);

							const headerRow = document.createElement('tr');
							['Dalībnieki', 'Dzimšanas gads', 'Klase'].forEach((header) => {
								const th = document.createElement('th');
								th.textContent = header;
								if (header === 'Dalībnieki') {
									th.classList.add('table-column-participant');
								} else if (header === 'Dzimšanas gads') {
									th.classList.add('table-column-birthyear');
								} else if (header === 'Klase') {
									th.classList.add('table-column-boatclass');
								}
								headerRow.appendChild(th);
							});
							table.appendChild(headerRow);

							uniqueClubTables[club].forEach((entry) => {
								const tr = document.createElement('tr');
								const cells = [entry.name, entry.year, entry.boatClasses];

								cells.forEach((cell, cellIndex) => {
									const td = document.createElement('td');
									td.innerHTML = cell;
									if (cellIndex === 0) {
										td.classList.add('table-column-participant');
									} else if (cellIndex === 1) {
										td.classList.add('table-column-birthyear');
									} else if (cellIndex === 2) {
										td.classList.add('table-column-boatclass');
									}
									tr.appendChild(td);
								});

								table.appendChild(tr);
							});

							colDiv.appendChild(table);
							containerDiv.appendChild(colDiv);
							entryListContainer.appendChild(containerDiv);
						};

						flagImg.onerror = () => {
							clubHeaderCell.innerHTML = `
								<span style="display: flex; align-items: center;">
									<span class="competition-number">${clubIndex + 1}</span>
									<span class="competition-symbol">${club}</span>
								</span>
							`;
							clubHeaderRow.appendChild(clubHeaderCell);
							table.appendChild(clubHeaderRow);

							const headerRow = document.createElement('tr');
							['Dalībnieki', 'Dzimšanas gads', 'Klase'].forEach((header) => {
								const th = document.createElement('th');
								th.textContent = header;
								if (header === 'Dalībnieki') {
									th.classList.add('table-column-participant');
								} else if (header === 'Dzimšanas gads') {
									th.classList.add('table-column-birthyear');
								} else if (header === 'Klase') {
									th.classList.add('table-column-boatclass');
								}
								headerRow.appendChild(th);
							});
							table.appendChild(headerRow);

							uniqueClubTables[club].forEach((entry) => {
								const tr = document.createElement('tr');
								const cells = [entry.name, entry.year, entry.boatClasses];

								cells.forEach((cell, cellIndex) => {
									const td = document.createElement('td');
									td.innerHTML = cell;
									if (cellIndex === 0) {
										td.classList.add('table-column-participant');
									} else if (cellIndex === 1) {
										td.classList.add('table-column-birthyear');
									} else if (cellIndex === 2) {
										td.classList.add('table-column-boatclass');
									}
									tr.appendChild(td);
								});

								table.appendChild(tr);
							});

							colDiv.appendChild(table);
							containerDiv.appendChild(colDiv);
							entryListContainer.appendChild(containerDiv);
						};
					});
				} catch (error) {
					console.error('Error processing or displaying club data:', error);
					entryListContainer.innerHTML = 'No data to show';
				}
			}

            async function showStats() {
				const stats = {};
				const allParticipants = new Set();

				try {
					const basePath = `../entrySys/${eventId}___${eventDate.replace(/-/g, '-')}___${encodeURIComponent(eventName)}/`;
					const participantsFilePath = `${basePath}participants.csv`;
					const entriesFilePath = `${basePath}entries.csv`;

					const [participantsResponse, entriesResponse] = await Promise.all([
						fetch(participantsFilePath),
						fetch(entriesFilePath),
					]);

					if (!participantsResponse.ok) throw new Error(`Failed to fetch participants.csv: ${participantsResponse.status} ${participantsResponse.statusText}`);
					if (!entriesResponse.ok) throw new Error(`Failed to fetch entries.csv: ${entriesResponse.status} ${entriesResponse.statusText}`);

					const [participantsCsvText, entriesCsvText] = await Promise.all([participantsResponse.text(), entriesResponse.text()]);

					const participantLines = participantsCsvText.split('\n').map(line => line.split(',').map(cell => cell.trim()));
					const participantHeaders = participantLines[0];
					const boatClassIndex = participantHeaders.indexOf('Event Abbrev');
					const organizationIndex = participantHeaders.indexOf('Crew');
					const participantsIndex = participantHeaders.indexOf('Stroke');

					if (boatClassIndex === -1 || organizationIndex === -1 || participantsIndex === -1) {
						console.error('Required columns are missing in participants.csv');
						return;
					}

					participantLines.slice(1).forEach(row => {
						const organization = row[organizationIndex] || 'Unknown';
						let participants = row[participantsIndex] || '';

						if (participants.includes(' | ')) {
							participants = participants.split(' | ')[1] || '';
						}

						if (!stats[organization]) {
							stats[organization] = { boatClasses: 0, uniqueAthletes: new Set(), totalAthletes: 0 };
						}

						const participantList = participants.split('<br>').map(participant => participant.trim());
						stats[organization].totalAthletes += participantList.length;

						participantList.forEach(participant => {
							stats[organization].uniqueAthletes.add(participant);
							allParticipants.add(participant);
						});
					});

					const entryLines = entriesCsvText.split('\n').map(line => line.split(',').map(cell => cell.trim()));
					const entryHeaders = entryLines[0];
					const entryOrganizationIndex = entryHeaders.indexOf('Crew');

					if (entryOrganizationIndex === -1) {
						console.error('Required columns are missing in entries.csv');
						return;
					}

					entryLines.slice(1).forEach(row => {
						const organization = row[entryOrganizationIndex] || 'Unknown';
						if (!stats[organization]) {
							stats[organization] = { boatClasses: 0, uniqueAthletes: new Set(), totalAthletes: 0 };
						}
						stats[organization].boatClasses += 1;
					});

					const table = document.createElement('table');
					table.classList.add('table', 'table-hover', 'table-bordered');

					const headerRow = document.createElement('tr');
					['#', 'Klubs', 'Laivas', 'Dalībnieki', 'Dalībnieki/Laivas'].forEach(header => {
						const th = document.createElement('th');
						th.textContent = header;
						headerRow.appendChild(th);
					});
					table.appendChild(headerRow);

					const sortedClubs = Object.keys(stats).sort((a, b) => a.localeCompare(b));
					const rows = await Promise.all(sortedClubs.map(async (club, index) => {
						const tr = document.createElement('tr');
						const indexCell = document.createElement('td');
						indexCell.textContent = index + 1;
						tr.appendChild(indexCell);

						const flagAndNameCell = document.createElement('td');
						const flagPath = `${basePath}flags/${club}.svg`;

						try {
							const flagResponse = await fetch(flagPath, { method: 'HEAD' });
							if (flagResponse.ok) {
								flagAndNameCell.innerHTML = `<span style="display: flex; align-items: center;">
									<img src="${flagPath}" alt="${club} Flag" style="width: 30px; height: auto; vertical-align: middle; margin-right: 10px;" />
									<span>${club}</span>
								</span>`;
							} else {
								flagAndNameCell.innerHTML = `<span>${club}</span>`;
							}
						} catch {
							flagAndNameCell.innerHTML = `<span>${club}</span>`;
						}

						tr.appendChild(flagAndNameCell);
						const { boatClasses, uniqueAthletes, totalAthletes } = stats[club];
						[boatClasses, uniqueAthletes.size, totalAthletes].forEach(cell => {
							const td = document.createElement('td');
							td.textContent = cell;
							tr.appendChild(td);
						});

						return tr;
					}));

					rows.forEach(row => table.appendChild(row));

					const summaryRow = document.createElement('tr');
					const totalBoatClasses = Object.values(stats).reduce((sum, clubStats) => sum + clubStats.boatClasses, 0);
					const totalParticipants = Object.values(stats).reduce((sum, clubStats) => sum + clubStats.totalAthletes, 0);

					summaryRow.innerHTML = `<td>Kopā</td><td></td><td>${totalBoatClasses}</td><td>${allParticipants.size}</td><td>${totalParticipants}</td>`;
					table.appendChild(summaryRow);

					entryListContainer.innerHTML = '';
					entryListContainer.appendChild(table);
				} catch (error) {
					console.error('Error displaying stats:', error);
					entryListContainer.innerHTML = 'No data to show';
				}
			}
        
            const buttons = document.querySelectorAll('.btn-group .btn');

            buttons.forEach(button => {
                button.addEventListener('click', function () {
                    // Reset all buttons: remove btn-primary and add btn-secondary
                    buttons.forEach(btn => {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    });
                    
                    // Set the clicked button: add btn-primary and remove btn-secondary
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-secondary');
                });
            });

            document.getElementById('sort-by-boat-class').addEventListener('click', sortByBoatClass);
            document.getElementById('sort-by-club').addEventListener('click', sortByClub);
            document.getElementById('show-stats').addEventListener('click', showStats);
        });
    </script>              
</body>
</html>