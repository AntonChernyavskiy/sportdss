<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSS Sport System</title>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Exo+2:300,400,700|Maven+Pro:400,700|Montserrat:300,400,700|Titillium+Web:300,400,700&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="../css/style.css">

    <meta name="viewport" content="width=430px" />
    <meta charset="utf-8">

    <style>
        table {
            line-height: 12px;
        }
        
        .event-element {
            background-color: #eee;
            padding: 8px 10px;
            margin: 4px 3px;
            display: inline-block;
            color: #0967ac;
            text-decoration: none;
            cursor: pointer;
        }

        /* Стили для элементов файлов */
        .file-element {
            display: block;
            color: #000000;
            border-bottom: 1px dashed #bbb;
            padding: 7px;
            font-weight: 350;
            cursor: pointer;
            text-decoration: none;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            background-color: #eee;
            margin: 4px 3px;
        }

        .file-element:hover {
            background-color: #eee;
            color: #000;
        }

        .file-element img {
            vertical-align: middle;
            margin-right: 8px;
        }

        .file-element span {
            margin-left: 8px;
        }

        /* Стили для кнопок категорий */
        .category-buttons {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-buttons button {
            margin: 5px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #0967ac;
            color: white;
            display: none; /* Изначально скрыты кнопки категорий */
        }

        .category-buttons button:hover {
            background-color: #0967ac;
        }

        /* Стили для эффекта подчеркивания при наведении */
        .hvr-underline-from-left {
            display: inline-block;
            vertical-align: middle;
            transform: perspective(1px) translateZ(0);
            position: relative;
            overflow: hidden;
        }

        .hvr-underline-from-left:before {
            content: "";
            position: absolute;
            z-index: -1;
            left: 0;
            right: 100%;
            bottom: 0;
            background: #2098D1;
            height: 4px;
            transition: right 0.3s ease-out;
        }

        .hvr-underline-from-left:hover:before,
        .hvr-underline-from-left:focus:before,
        .hvr-underline-from-left:active:before {
            right: 0;
        }

        /* Стили для информации о гонках */
        .race-info {
            display: flex;
            flex-wrap: wrap; /* Позволяет элементам переноситься на новые строки на узких экранах */
            gap: 10px; /* Расстояние между элементами */
        }

        .race-info span {
            color: #2098D1; /* Цвет текста */
            font-weight: bold; /* Жирный текст */
        }

        .race-info .label {
            font-weight: normal; /* Метки не должны быть жирными */
            color: #000; /* Цвет меток */
        }

        .eta {
            font-weight: bold;
        }

        /* Стили для меню прокрутки */
        .scrollMenu {
            overflow-y: auto;
            max-height: 40vh;
            width: 100%;
        }

        /* Стили для модального окна */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 70% !important;
            height: 80%;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
        }

        /* Стили для результатов новостей в модальном окне */
        .newsResults {
            flex: 1 1 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .newsResults h2 {
            margin-bottom: 15px;
        }

        /* Стили для разделов модального окна */
        .modal-section {
            margin-bottom: 20px;
            flex: 1 1 calc(50% - 40px);
        }

        .modal-section h2 {
            font-size: 24px;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .modal-section ul {
            list-style: none;
            padding: 0;
            margin: 0; /* Добавлен сброс отступов */
        }

        .modal-section ul li {
            margin-bottom: 5px;
        }

        .modal-section ul li a {
            text-decoration: none;
            color: #0967ac;
        }

        .modal-section ul li a:hover {
            text-decoration: underline;
        }

        /* Адаптивные стили для модального окна */
        @media (max-width: 991px) {
            .modal-box {
                width: 90% !important;
                height: auto;
                max-height: 90%;
                overflow-y: auto;
            }
        }

        @media (max-width: 767px) {
            .modal-box {
                width: 100% !important;
                height: auto;
                max-height: 90%;
                overflow-y: auto;
                padding: 10px;
            }

            .modal-close {
                font-size: 1.2em;
                top: 5px;
                right: 5px;
            }

            .modal-section {
                flex: 1 1 100%;
                margin-bottom: 10px;
            }
        }
        #competitions-table {
            display: none;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <div class="navbar-brand" href="/">
                <span>
                    DSS Sport System
                </span>
            </div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav" style="padding-right: 10px; margin-right: 10px;">
                    <li class="nav-item hvr-underline-from-left active">
                        <a class="nav-link" href="https://sportdss.eu/results">Rezultāti</a>
                    </li>
                    <li class="nav-item hvr-underline-from-left">
                        <a class="nav-link" href="https://sportdss.eu">Pieteikšanas</a>
                    </li>
                    <li class="nav-item hvr-underline-from-left">
                        <a class="nav-link" href="https://sportdss.eu/liveresults">Dzīvie rezultāti</a>
                    </li>
                </ul>
            </div>
            <input type="text" id="search-input" placeholder=" meklēt sacensības..." class="form-inline my-2 my-lg-0 search-place">
        </div>
    </nav>
    <div class="container main-content">
        <h4>Results / Rezultāti</h4>
        <div class="row">
            <div class="col-12">
                <table class="table table-striped table-hover table-bordered" style="width: 100%" id="competitions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Datums</th>
                            <th>Pasākums</th>
                        </tr>
                    </thead>
                    <tbody id="competitions-files">
                    </tbody>
                </table>

                <div class="dataTables_info" id="dataTable_info" role="status" aria-live="polite"></div>
                <div class="dataTables_paginate paging_simple_numbers" id="dataTable_paginate">
                    <a class="event-element hvr-underline-from-left" aria-controls="dataTable" data-dt-idx="0" tabindex="0" id="dataTable_previous" style="text-decoration: none;">Iepriekšēja</a>
                    <span id="pagination-buttons">
                        <!-- Pagination buttons will be dynamically generated here -->
                    </span>
                    <a class="event-element hvr-underline-from-left" aria-controls="dataTable" data-dt-idx="7" tabindex="0" id="dataTable_next" style="text-decoration: none;">Nākama</a>
                </div>                
            </div>
        </div>
    </div>
    <!--modal-overlay -> modal, modal-box -> modal-content, modal-close -> close-modal, modal-section -> newsResults, -->
    <div id="myModal" class="modal-overlay">
        <div class="modal-box">
            <span class="modal-close">&times;</span>
            <div class="modal-section">
                <h2>Start lists / Starta protokoli</h2>
                <div class="scrollMenu">
                    <ul id="startlists"></ul>
                </div>
            </div>
            <div class="modal-section">
                <h2>Races / Braucieni</h2>
                <div class="scrollMenu">
                    <ul id="results-list"></ul>
                </div>
            </div>
            <div class="modal-section">
                <h2>Results / Rezultāti</h2>
                <div class="category-buttons" id="category-buttons"></div>
            </div>
            <div class="modal-section">
                <h2>Other files / Citi dokumenti</h2>
                <div class="scrollMenu">
                    <ul id="other-files"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../js/filter.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/files')
                .then(response => response.json())
                .then(data => {
                    // Фильтруем данные, исключая папки .cagefs и .cl.selector
                    const filteredData = data.filter(entry => {
                        return !entry.includes('.cagefs') && !entry.includes('.cl.selector');
                    });

                    const competitionsTable = document.getElementById('competitions-table');
                    const competitionsBody = competitionsTable.querySelector('tbody');
                    const paginationButtonsContainer = document.getElementById('pagination-buttons');
                    const infoDiv = document.getElementById('dataTable_info');
                    const rowsPerPage = 10;
                    let currentPage = 1;

                    // Сортировка данных от новых к старым
                    filteredData.sort((a, b) => {
                        const noveltyA = parseInt(a.split('___')[0], 10);
                        const noveltyB = parseInt(b.split('___')[0], 10);
                        const dateA = new Date(a.split('___')[1].split('-').reverse().join('-')); // Преобразуем формат DD-MM-YYYY в YYYY-MM-DD
                        const dateB = new Date(b.split('___')[1].split('-').reverse().join('-'));
                        if (noveltyB === noveltyA) {
                            return dateB - dateA; // Сортировка по дате, если новизна одинакова
                        }
                        return noveltyB - noveltyA; // Сортировка по новизне
                    });


                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);

                    function updateInfoText() {
                        const start = (currentPage - 1) * rowsPerPage + 1;
                        const end = Math.min(currentPage * rowsPerPage, filteredData.length);
                        infoDiv.textContent = `Pozīcijas no ${start} līdz ${end} no ${filteredData.length} kopā`;
                    }

                    function displayPage(page) {
                        competitionsBody.innerHTML = '';
                        const start = (page - 1) * rowsPerPage;
                        const end = Math.min(start + rowsPerPage, filteredData.length);

                        const pageData = filteredData.slice(start, end);

                        pageData.forEach((entry, index) => {
                            const [novelty, date, eventName] = entry.split('___'); // Получаем новизну, дату и название

                            const tr = document.createElement('tr');
                            tr.classList.add('event-row');

                            const tdNumber = document.createElement('td');
                            tdNumber.textContent = start + index + 1;

                            const tdDate = document.createElement('td');
                            tdDate.textContent = date;

                            const tdEventName = document.createElement('td');
                            const eventNameLink = document.createElement('a');
                            eventNameLink.textContent = eventName;
                            eventNameLink.classList.add('hvr-bubble-float-left');
                            eventNameLink.href = '#';

                            // Передаем novelty, date и eventName в обработчик
                            eventNameLink.onclick = function () {
                                fetchAndDisplayResults(eventName, date, novelty); // Передаем новизну в функцию
                                
                                const modal = document.getElementById('myModal');
                                modal.style.display = 'flex';
                                document.getElementById('search-input').value = '';
                                return false;
                            };

                            tdEventName.appendChild(eventNameLink);

                            tr.appendChild(tdNumber);
                            tr.appendChild(tdDate);
                            tr.appendChild(tdEventName);

                            competitionsBody.appendChild(tr);
                        });

                        updateInfoText();
                    }

                    function updatePagination() {
                        paginationButtonsContainer.innerHTML = '';

                        for (let i = 1; i <= totalPages; i++) {
                            const pageButton = document.createElement('span');
                            pageButton.classList.add('event-element', 'hvr-underline-from-left');
                            if (i === currentPage) {
                                pageButton.classList.add('results-active');
                            }
                            pageButton.textContent = i;
                            pageButton.onclick = (function (i) {
                                return function () {
                                    currentPage = i;
                                    displayPage(i);
                                    updatePagination();
                                    return false;
                                }
                            })(i);

                            paginationButtonsContainer.appendChild(pageButton);
                        }

                        const prevButton = document.getElementById('dataTable_previous');
                        const nextButton = document.getElementById('dataTable_next');

                        prevButton.classList.toggle('disabled', currentPage === 1);
                        nextButton.classList.toggle('disabled', currentPage === totalPages);
                    }

                    document.getElementById('dataTable_previous').onclick = function () {
                        if (currentPage > 1) {
                            currentPage--;
                            displayPage(currentPage);
                            updatePagination();
                        }
                        return false;
                    };

                    document.getElementById('dataTable_next').onclick = function () {
                        if (currentPage < totalPages) {
                            currentPage++;
                            displayPage(currentPage);
                            updatePagination();
                        }
                        return false;
                    };

                    function showTable() {
                        competitionsTable.style.display = 'table';
                        displayPage(1);
                        updatePagination();

                        const firstPageButton = paginationButtonsContainer.querySelector('span.event-element');
                        if (firstPageButton) {
                            firstPageButton.classList.add('results-active');
                        }
                    }

                    showTable();

                    const events = data.map(entry => {
                        const [date, eventName] = entry.split('  ');
                        return { date: date, name: eventName };
                    });
    
                    const searchInput = document.getElementById('search-input');
                    searchInput.addEventListener('input', function () {
                        const searchInputValue = searchInput.value.toLowerCase();
                        filterCompetitions(searchInputValue);
                    });
    
                    function filterCompetitions(query) {
                        const rows = competitionsTable.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const eventName = row.cells[2].textContent.toLowerCase();
                            if (eventName.includes(query)) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        });
                    }
    
                    function typeName(type) {
                        switch (type) {
                            case 'T': return 'Time Trials / Handikapi';
                            case 'H': return 'Heats / Priekšbraucieni';
                            case 'R': return 'Reps';
                            case 'K': return 'Knockouts';
                            case 'Q': return 'Quarterfinals';
                            case 'S': return 'Semifinals / Pusfināli';
                            case 'F': return 'Finals / Fināli';
                            default: return '';
                        }
                    }
    
                    function fetchAndDisplayResults(eventName, eventDate, novelty) {
                        const modalStartlistsContainer = document.getElementById('startlists');
                        const modalResultsListContainer = document.getElementById('results-list');
                        const modalOtherFilesContainer = document.getElementById('other-files');
                        const categoryButtonsContainer = document.getElementById('category-buttons');

                        modalStartlistsContainer.innerHTML = '';
                        modalResultsListContainer.innerHTML = '';
                        modalOtherFilesContainer.innerHTML = '';
                        categoryButtonsContainer.innerHTML = '';

                        const [year, month, day] = eventDate.split('-');
                        const formattedDate = `${year}-${month}-${day}`;
                        const formattedEventName = encodeURIComponent(eventName);
                        const urlPath = `${novelty}___${formattedDate}___${formattedEventName}`;

                        // Обновляем адресную строку
                        const newUrl = `${window.location.pathname}?event=${formattedEventName}&date=${formattedDate}`;
                        history.pushState({ event: eventName, date: eventDate }, '', newUrl);

                        fetch(`/files/${urlPath}/`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                const { baseFiles, resultsFiles, startlistsFiles } = data;

                                baseFiles.forEach(file => {
                                    const fileUrl = `/files/${urlPath}/${encodeURIComponent(file)}`;
                                    const fileElement = document.createElement('a');
                                    fileElement.classList.add('file-element');
                                    fileElement.href = fileUrl;
                                    fileElement.target = '_blank';

                                    if (isMobileDevice()) {
                                        fileElement.setAttribute('download', '');
                                    }

                                    const span = document.createElement('span');
                                    span.textContent = file;
                                    fileElement.appendChild(span);

                                    modalOtherFilesContainer.appendChild(fileElement);
                                });

                                startlistsFiles.forEach(file => {
                                    const fileUrl = `/files/${urlPath}/Startlists/${encodeURIComponent(file)}`;
                                    const fileElement = document.createElement('a');
                                    fileElement.classList.add('file-element');
                                    fileElement.href = fileUrl;
                                    fileElement.target = '_blank';

                                    if (isMobileDevice()) {
                                        fileElement.setAttribute('download', '');
                                    }

                                    const span = document.createElement('span');
                                    span.textContent = file;
                                    fileElement.appendChild(span);

                                    modalStartlistsContainer.appendChild(fileElement);
                                });

                                const categories = new Set();
                                const raceFiles = [];

                                resultsFiles.forEach(file => {
                                    const raceMatch = file.match(/race-(\d+)___event-(\d+)___name-([A-Za-z0-9\-]+)___eta-([A-Za-z0-9]+)/);
                                    if (raceMatch) {
                                        const fileCategory = raceMatch[3];
                                        categories.add(fileCategory);
                                        raceFiles.push({ file });
                                    }
                                });

                                categories.forEach(category => {
                                    const button = document.createElement('span');
                                    button.classList.add('event-element', 'hvr-underline-from-left');
                                    button.textContent = category;
                                    button.onclick = function () {
                                        displayResultsForCategory(category, raceFiles, eventDate, eventName, novelty);
                                        categoryButtonsContainer.querySelectorAll('span').forEach(btn => btn.classList.remove('results-active'));
                                        button.classList.add('results-active');
                                    };
                                    categoryButtonsContainer.appendChild(button);
                                });
                            })
                            .catch(error => console.error('Error loading results:', error));
                    }

                    function displayResultsForCategory(category, raceFiles, eventDate, eventName, novelty) {
                        const modalResultsListContainer = document.getElementById('results-list');
                        const categoryButtonsContainer = document.getElementById('category-buttons');
                        modalResultsListContainer.innerHTML = ''; // Очищаем контейнер результатов

                        const groupedResults = {
                            T: [],
                            H: [],
                            R: [],
                            K: [],
                            Q: [],
                            S: [],
                            F: []
                        };

                        raceFiles.forEach(({ file }) => {
                            const match = file.match(/race-(\d+)___event-(\d+)___name-([A-Za-z0-9\-]+)___eta-([A-Za-z0-9]+)/);
                            if (match) {
                                const [, raceNo, eventNo, fileCategory, eta] = match;
                                if (fileCategory === category) {
                                    let etaType = eta[0];

                                    if (etaType === 'F' && eta.length > 1) {
                                        etaType = 'F';
                                    }

                                    if (!groupedResults[etaType]) {
                                        groupedResults[etaType] = [];
                                    }
                                    groupedResults[etaType].push(file);
                                }
                            }
                        });

                        Object.keys(groupedResults).forEach(raceType => {
                            if (groupedResults[raceType].length > 0) {
                                const typeHeader = document.createElement('h5');
                                typeHeader.textContent = typeName(raceType);
                                modalResultsListContainer.appendChild(typeHeader);

                                groupedResults[raceType].forEach(file => {
                                    const raceMatch = file.match(/race-(\d+)___event-(\d+)___name-([A-Za-z0-9\-]+)___eta-([A-Za-z0-9]+)/);
                                    const [, raceNo, eventNo, fileCategory, eta] = raceMatch;

                                    const raceElement = document.createElement('a');
                                    raceElement.classList.add('file-element');
                                    raceElement.href = `/files/${novelty}___${eventDate}___${encodeURIComponent(eventName)}/Results/${encodeURIComponent(file)}`;
                                    raceElement.target = '_blank';

                                    const raceInfo = document.createElement('div');
                                    raceInfo.classList.add('race-info');

                                    const etaElement = document.createElement('span');
                                    etaElement.textContent = `[${eta}]`;

                                    const raceNoElement = document.createElement('span');
                                    raceNoElement.innerHTML = `<span class="label">race no / brauciena nr:</span> ${raceNo}`;

                                    const eventNoElement = document.createElement('span');
                                    eventNoElement.innerHTML = `<span class="label">event no / konkurences nr:</span> ${eventNo}`;

                                    raceInfo.appendChild(etaElement);
                                    raceInfo.appendChild(raceNoElement);
                                    raceInfo.appendChild(eventNoElement);
                                    raceElement.appendChild(raceInfo);

                                    modalResultsListContainer.appendChild(raceElement);
                                });
                            }
                        });

                        // Обновление кнопок категорий
                        categoryButtonsContainer.querySelectorAll('span').forEach(btn => {
                            btn.classList.remove('results-active'); // Сброс выделения всех кнопок
                        });
                        
                        const activeButton = Array.from(categoryButtonsContainer.children).find(btn => btn.textContent === category);
                        if (activeButton) {
                            activeButton.classList.add('results-active'); // Выделяем активную кнопку
                        }
                    }

                    const spanClose = document.getElementsByClassName('modal-close')[0];
                    spanClose.onclick = function () {
                        const modal = document.getElementById('myModal');
                        modal.style.display = 'none';
                    };
    
                    window.onclick = function (event) {
                        const modal = document.getElementById('myModal');
                        if (event.target == modal) {
                            modal.style.display = 'none';
                        }
                    };
    
                    function isMobileDevice() {
                        return /Mobi/i.test(navigator.userAgent);
                    }
    
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventParam = urlParams.get('event');
                    const dateParam = urlParams.get('date');

                    if (eventParam && dateParam) {
                        const novelty = ''; // Укажите здесь значение novelty, если оно фиксировано, или получите его из другого источника
                        fetchAndDisplayResults(eventParam, dateParam, novelty);
                        const modal = document.getElementById('myModal');
                        modal.style.display = 'flex';
                    }

                });
        });
    </script>    
    <footer style="text-align: center;" class="d-print-none">
        <br>
        <hr>
        2024 © DSS Sport System. All rights reserved.
    </footer>
</body>
</html>